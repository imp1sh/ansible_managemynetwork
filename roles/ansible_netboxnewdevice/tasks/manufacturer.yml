---
- name: "MMN NND - Fetch all manufacturers from Netbox"
  ansible.builtin.set_fact:
    nnd_manufacturers_list: "{{ query('netbox.netbox.nb_lookup', 'manufacturers', api_endpoint=NETBOX_URL, token=NETBOX_TOKEN) }}"

- name: "MMN NND - Create list of manufacturers with IDs, slugs, and names"
  ansible.builtin.set_fact:
    nnd_manufacturers_with_ids: "{{ nnd_manufacturers_with_ids | default([]) + [{'id': item.id, 'slug': item.slug, 'name': item.name}] }}"
  loop: "{{ nnd_manufacturers_list | map(attribute='value') | list }}"
  loop_control:
    loop_var: item

- name: "MMN NND - Build table rows"
  ansible.builtin.set_fact:
    manufacturers_table_rows: "{{ manufacturers_table_rows | default([]) + [row] }}"
  vars:
    id_str: "{{ item.id | string }}"
    id_pad: "{{ ('   ' if id_str | length == 1 else ('  ' if id_str | length == 2 else (' ' if id_str | length == 3 else ''))) }}"
    slug_str: "{{ item.slug }}"
    slug_len: "{{ slug_str | length }}"
    slug_pad: "{{ ('                                        '[:39 - slug_len] if slug_len < 39 else '') }}"
    row: "{{ id_pad }}{{ id_str }}  | {{ slug_str }}{{ slug_pad }} | {{ item.name }}"
  loop: "{{ nnd_manufacturers_with_ids }}"
  loop_control:
    loop_var: item

- name: "MMN NND - Build complete table message"
  ansible.builtin.set_fact:
    manufacturers_table_msg: "{{ ['Available Manufacturers:', '====================================================================================', 'ID     | Slug                                    | Name', '-------+-----------------------------------------+-----------------------------------'] + manufacturers_table_rows + ['===================================================================================='] }}"

- name: "MMN NND - Display all available manufacturers in table format"
  ansible.builtin.debug:
    msg: "{{ manufacturers_table_msg }}"

- name: "MMN NND - Prompt for manufacturer ID"
  ansible.builtin.pause:
    prompt: |
      Enter the ID of the manufacturer you want to use:
  register: manufacturer_id_input
  run_once: true

- name: "MMN NND - Validate manufacturer ID input"
  ansible.builtin.assert:
    that:
      - manufacturer_id_input.user_input | int > 0
      - manufacturer_id_input.user_input | int in (nnd_manufacturers_with_ids | map(attribute='id') | list)
    fail_msg: "Invalid manufacturer ID. Please enter a valid ID from the list above."
    success_msg: "Manufacturer ID is valid."
  run_once: true

- name: "MMN NND - Set selected manufacturer"
  ansible.builtin.set_fact:
    selected_manufacturer: "{{ nnd_manufacturers_with_ids | selectattr('id', 'equalto', manufacturer_id_input.user_input | int) | first }}"

- name: "MMN NND - Display selected manufacturer"
  ansible.builtin.debug:
    msg: "Selected manufacturer: {{ selected_manufacturer.name }} (ID: {{ selected_manufacturer.id }})"
