---
- name: "MMN NND - Fetch all sites from Netbox"
  ansible.builtin.set_fact:
    nnd_sites_list: "{{ query('netbox.netbox.nb_lookup', 'sites', api_endpoint=NETBOX_URL, token=NETBOX_TOKEN) }}"

- name: "MMN NND - Create list of sites with IDs, slugs, and names"
  ansible.builtin.set_fact:
    nnd_sites_numbered: "{{ nnd_sites_numbered | default([]) + [{'id': item.id, 'name': item.name, 'slug': item.slug}] }}"
  loop: "{{ nnd_sites_list | map(attribute='value') | list }}"
  loop_control:
    loop_var: item

- name: "MMN NND - Build table rows for sites"
  ansible.builtin.set_fact:
    sites_table_rows: "{{ sites_table_rows | default([]) + [row] }}"
  vars:
    id_str: "{{ item.id | string }}"
    id_pad: "{{ ('   ' if id_str | length == 1 else ('  ' if id_str | length == 2 else (' ' if id_str | length == 3 else ''))) }}"
    slug_str: "{{ item.slug }}"
    slug_len: "{{ slug_str | length }}"
    slug_pad: "{{ ('                                        '[:39 - slug_len] if slug_len < 39 else '') }}"
    row: "{{ id_pad }}{{ id_str }}  | {{ slug_str }}{{ slug_pad }} | {{ item.name }}"
  loop: "{{ nnd_sites_numbered }}"
  loop_control:
    loop_var: item

- name: "MMN NND - Build complete sites table message"
  ansible.builtin.set_fact:
    sites_table_msg: "{{ ['Available Sites:', '====================================================================================', 'ID     | Slug                                    | Name', '-------+-----------------------------------------+-----------------------------------'] + sites_table_rows + ['===================================================================================='] }}"

- name: "MMN NND - Display all available sites in table format"
  ansible.builtin.debug:
    msg: "{{ sites_table_msg }}"

- name: "MMN NND - Prompt for site ID"
  ansible.builtin.pause:
    prompt: |
      Enter the ID of the site you want to use:
  register: site_id_input
  run_once: true

- name: "MMN NND - Validate site ID input"
  ansible.builtin.assert:
    that:
      - site_id_input.user_input | int > 0
      - site_id_input.user_input | int in (nnd_sites_numbered | map(attribute='id') | list)
    fail_msg: "Invalid site ID. Please enter a valid ID from the list above."
    success_msg: "Site ID is valid."
  run_once: true

- name: "MMN NND - Set selected site"
  ansible.builtin.set_fact:
    selected_site: "{{ nnd_sites_numbered | selectattr('id', 'equalto', site_id_input.user_input | int) | first }}"

- name: "MMN NND - Display selected site"
  ansible.builtin.debug:
    msg: "Selected site: {{ selected_site.name }} (ID: {{ selected_site.id }})"
