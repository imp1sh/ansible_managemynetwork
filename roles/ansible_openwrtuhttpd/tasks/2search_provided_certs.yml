---
# Search for explicitly set cert/key files in common paths
- name: MMN openwrtuhttpd - Check if cert/key vars are explicitly set
  ansible.builtin.set_fact:
    _cert_explicitly_set: "{{ openwrt_uhttpd_main_cert is defined and openwrt_uhttpd_main_cert != '/etc/uhttpd.crt' }}"
    _key_explicitly_set: "{{ openwrt_uhttpd_main_key is defined and openwrt_uhttpd_main_key != '/etc/uhttpd.key' }}"

- name: MMN openwrtuhttpd - Extract filename from provided cert path
  ansible.builtin.set_fact:
    _provided_cert_filename: "{{ openwrt_uhttpd_main_cert | basename }}"
  when: _cert_explicitly_set | default(false) | bool

- name: MMN openwrtuhttpd - Extract filename from provided key path
  ansible.builtin.set_fact:
    _provided_key_filename: "{{ openwrt_uhttpd_main_key | basename }}"
  when: _key_explicitly_set | default(false) | bool

- name: MMN openwrtuhttpd - Extract base filename without extension for cert
  ansible.builtin.set_fact:
    _provided_cert_basename: "{{ _provided_cert_filename | regex_replace('\\.(cer|pem|crt)$', '') }}"
  when: _provided_cert_filename is defined

- name: MMN openwrtuhttpd - Extract base filename without extension for key
  ansible.builtin.set_fact:
    _provided_key_basename: "{{ _provided_key_filename | regex_replace('\\.(key|pem)$', '') }}"
  when: _provided_key_filename is defined

- name: MMN openwrtuhttpd - Search for provided cert in common paths
  ansible.builtin.find:
    paths:
      - "{{ openwrt_uhttpd_deployroot }}etc/acme"
      - "{{ openwrt_uhttpd_deployroot }}etc/ssl/certs"
      - "{{ openwrt_uhttpd_deployroot }}etc/ssl/private"
      - "{{ openwrt_uhttpd_deployroot }}etc"
    file_type: file
    patterns:
      - "{{ _provided_cert_basename }}.cer"
      - "{{ _provided_cert_basename }}.pem"
      - "{{ _provided_cert_basename }}.crt"
      - "{{ _provided_cert_filename }}"
    recurse: true
  register: found_provided_cert
  when: _provided_cert_basename is defined

- name: MMN openwrtuhttpd - Search for provided key in common paths
  ansible.builtin.find:
    paths:
      - "{{ openwrt_uhttpd_deployroot }}etc/acme"
      - "{{ openwrt_uhttpd_deployroot }}etc/ssl/certs"
      - "{{ openwrt_uhttpd_deployroot }}etc/ssl/private"
      - "{{ openwrt_uhttpd_deployroot }}etc"
    file_type: file
    patterns:
      - "{{ _provided_key_basename }}.key"
      - "{{ _provided_key_basename }}.pem"
      - "{{ _provided_key_filename }}"
    recurse: true
  register: found_provided_key
  when: _provided_key_basename is defined

- name: MMN openwrtuhttpd - Set found cert path from search
  ansible.builtin.set_fact:
    openwrt_uhttpd_main_cert: "{{ found_provided_cert.files[0].path }}"
  when: found_provided_cert.matched | default(0) > 0

- name: MMN openwrtuhttpd - Set found key path from search
  ansible.builtin.set_fact:
    openwrt_uhttpd_main_key: "{{ found_provided_key.files[0].path }}"
  when: found_provided_key.matched | default(0) > 0

- name: MMN openwrtuhttpd - Verbose found provided cert/key
  ansible.builtin.debug:
    msg: "Found cert: {{ openwrt_uhttpd_main_cert }}, key: {{ openwrt_uhttpd_main_key }}"
  when: (found_provided_cert.matched | default(0) > 0) or (found_provided_key.matched | default(0) > 0)

